{"version":"7","defaultTimeframe":{"from":"now()-2h","to":"now()"},"defaultSegments":[],"sections":[{"id":"6a9652c0-f9f3-40b7-a49d-9ed62ee793b4","type":"markdown","markdown":"# MZ2POL-00: SDK Management Zone Analysis Tool\n\n> **Series:** MZ2POL | **Notebook:** 1 of 8 | **Created:** December 2025\n\n> **Purpose:** Query Management Zone configurations via the Dynatrace SDK, analyze entity assignments, and assess security context coverage to support migration planning.\n\n## What This Notebook Does\n\n1. **Export all MZ configurations** - Get all MZ rules in a flat table format via Settings API\n2. **Analyze MZ rule patterns** - Understand what types of rules are in use\n3. **Check entity security context coverage** - Find entities missing `dt.security_context`\n4. **Identify most-used MZs** - Prioritize migration based on usage\n5. **Find tag patterns** - Discover common tag structures for segment creation\n6. **Kubernetes namespace analysis** - K8s namespaces for segment variables\n7. **Host group analysis** - Host groups for vertical MZ migration\n8. **Migration readiness summary** - Combined view of readiness indicators\n\n---"},{"id":"ab8230b9-f5a5-42c3-afa8-b602d2688a49","type":"markdown","markdown":"## 1. Export All Management Zone Configurations\n\nThis TypeScript function queries all MZs via the Settings API and flattens their rules into an analyzable table."},{"id":"267664c4-97c4-457e-9693-4567cb15154d","type":"function","showTitle":false,"drilldownPath":[],"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"import { settingsObjectsClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\n// Type definitions\ninterface MzAttributeRuleCondition {\nkey: string;\noperator: string;\ntag?: string;\nstringValue?: string;\ncaseSensitive?: boolean;\n}\n\ninterface MzAttributeRule {\nentityType: string;\nserviceToHostPropagation?: boolean;\nserviceToPGPropagation?: boolean;\nconditions?: MzAttributeRuleCondition[];\n}\n\ninterface MzRule {\nenabled: boolean;\ntype: string;\nentitySelector?: string;\nattributeRule: MzAttributeRule[];\n}\n\ninterface MzDefinition {\nname: string;\ndescription?: string;\nrules: MzRule[];\n}\n\n// Fetch all MZs with pagination\nasync function getAllMZs(nextPageKey?: string, mzList: MzDefinition[] = []): Promise<MzDefinition[]> {\nconst config: any = nextPageKey \n? { nextPageKey } \n: { schemaIds: \"builtin:management-zones\", pageSize: 100, fields: \"objectId,value\" };\n\nconst resp = await settingsObjectsClient.getSettingsObjects(config);\nmzList.push(...resp.items.map(elem => elem.value as MzDefinition));\n\nreturn resp.nextPageKey ? getAllMZs(resp.nextPageKey, mzList) : mzList;\n}\n\n// Flatten rules into records\nfunction flattenRules(mzList: MzDefinition[]): any[] {\nconst records: any[] = [];\n\nmzList.forEach(mz => {\nmz.rules?.forEach(rule => {\nif (rule.attributeRule) {\nconst attr = rule.attributeRule;\nconst base = {\nmzName: mz.name,\ndescription: mz.description || \"\",\nruleType: rule.type,\nruleEnabled: rule.enabled,\nentityType: attr.entityType || \"\",\npropagateToHost: attr.serviceToHostPropagation || false,\npropagateToPG: attr.serviceToPGPropagation || false\n};\n\nif (attr.conditions?.length) {\nattr.conditions.forEach(c => {\nrecords.push({\n...base,\nconditionKey: c.key,\noperator: c.operator,\nvalue: c.stringValue || c.tag || \"\",\ncaseSensitive: c.caseSensitive || false\n});\n});\n} else {\nrecords.push({ ...base, conditionKey: \"\", operator: \"\", value: \"\", caseSensitive: false });\n}\n}\n\nif (rule.type === \"SELECTOR\") {\nrecords.push({\nmzName: mz.name,\ndescription: mz.description || \"\",\nruleType: \"SELECTOR\",\nruleEnabled: rule.enabled,\nentityType: \"\",\npropagateToHost: false,\npropagateToPG: false,\nconditionKey: \"entitySelector\",\noperator: \"SELECTOR\",\nvalue: rule.entitySelector || \"\",\ncaseSensitive: false\n});\n}\n});\n});\n\nreturn records;\n}\n\nexport default async function() {\nconst mzList = await getAllMZs();\nreturn flattenRules(mzList);\n}"},"visualizationSettings":{"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"39a9a4da-d1f7-42fc-9977-82f1707702e6","type":"markdown","markdown":"---\n\n## 2. MZ Rule Pattern Analysis\n\nAnalyze what types of MZ rules are in use to understand migration complexity."},{"id":"464842ea-1f0a-48ab-9bff-95d10563eaee","type":"function","showTitle":false,"drilldownPath":[],"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"import { settingsObjectsClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\ninterface MzRule {\nenabled: boolean;\ntype: string;\nentitySelector?: string;\nattributeRule?: { entityType: string; conditions?: { key: string; operator: string }[] }[];\n}\n\ninterface MzDefinition {\nname: string;\nrules: MzRule[];\n}\n\nasync function getAllMZs(nextPageKey?: string, mzList: MzDefinition[] = []): Promise<MzDefinition[]> {\nconst config: any = nextPageKey \n? { nextPageKey } \n: { schemaIds: \"builtin:management-zones\", pageSize: 100, fields: \"objectId,value\" };\nconst resp = await settingsObjectsClient.getSettingsObjects(config);\nmzList.push(...resp.items.map(elem => elem.value as MzDefinition));\nreturn resp.nextPageKey ? getAllMZs(resp.nextPageKey, mzList) : mzList;\n}\n\nexport default async function() {\nconst mzList = await getAllMZs();\n\n// Count patterns\nconst stats = {\ntotalMZs: mzList.length,\ntotalRules: 0,\nbyRuleType: {} as Record<string, number>,\nbyEntityType: {} as Record<string, number>,\nbyConditionKey: {} as Record<string, number>,\nbyOperator: {} as Record<string, number>,\nselectorRules: 0,\nmeRules: 0,\ntagBasedRules: 0,\nnameBasedRules: 0\n};\n\nmzList.forEach(mz => {\nmz.rules?.forEach(rule => {\nstats.totalRules++;\nstats.byRuleType[rule.type] = (stats.byRuleType[rule.type] || 0) + 1;\n\nif (rule.type === \"SELECTOR\") {\nstats.selectorRules++;\n} else if (rule.type === \"ME\" && rule.attributeRule) {\nstats.meRules++;\nconst attr = rule.attributeRule;\nstats.byEntityType[attr.entityType] = (stats.byEntityType[attr.entityType] || 0) + 1;\n\nattr.conditions?.forEach(c => {\nstats.byConditionKey[c.key] = (stats.byConditionKey[c.key] || 0) + 1;\nstats.byOperator[c.operator] = (stats.byOperator[c.operator] || 0) + 1;\n\nif (c.key.includes(\"TAGS\")) stats.tagBasedRules++;\nif (c.key.includes(\"NAME\")) stats.nameBasedRules++;\n});\n}\n});\n});\n\n// Convert to table format\nconst results = [\n{ category: \"Summary\", metric: \"Total Management Zones\", count: stats.totalMZs },\n{ category: \"Summary\", metric: \"Total Rules\", count: stats.totalRules },\n{ category: \"Summary\", metric: \"Avg Rules per MZ\", count: Math.round(stats.totalRules / stats.totalMZs * 10) / 10 },\n{ category: \"Rule Type\", metric: \"SELECTOR rules\", count: stats.selectorRules },\n{ category: \"Rule Type\", metric: \"ME (attribute) rules\", count: stats.meRules },\n{ category: \"Pattern\", metric: \"Tag-based rules\", count: stats.tagBasedRules },\n{ category: \"Pattern\", metric: \"Name-based rules\", count: stats.nameBasedRules }\n];\n\n// Add top entity types\nObject.entries(stats.byEntityType)\n.sort((a, b) => b[1] - a[1])\n.slice(0, 10)\n.forEach(([type, count]) => {\nresults.push({ category: \"Entity Type\", metric: type, count });\n});\n\n// Add top condition keys\nObject.entries(stats.byConditionKey)\n.sort((a, b) => b[1] - a[1])\n.slice(0, 10)\n.forEach(([key, count]) => {\nresults.push({ category: \"Condition Key\", metric: key, count });\n});\n\nreturn results;\n}"},"visualizationSettings":{"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"30bf8423-52e6-4220-b678-0b82caa03924","type":"markdown","markdown":"---\n\n## 3. Entity Security Context Coverage\n\nCheck how many entities have `dt.security_context` set vs those relying only on `managementZones`.\n\n### Service Coverage"},{"id":"1499861f-3636-4081-869f-9d1744b3332f","type":"dql","filterSegments":[],"drilldownPath":[],"previousFilterSegments":[],"height":250,"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"fetch dt.entity.service\n| summarize\ntotal = count(),\nwithSecurityContext = countIf(isNotNull(dt.security_context)),\nwithMZs = countIf(isNotNull(managementZones)),\nnoAccess = countIf(isNull(dt.security_context) AND isNull(managementZones))\n| fieldsAdd \nsecurityContextPercent = round(100.0 * withSecurityContext / total, decimals: 2),\nmzPercent = round(100.0 * withMZs / total, decimals: 2)"},"visualizationSettings":{"table":{"hideColumnsForLargeResults":true},"autoSelectVisualization":true,"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"83d402ba-ff19-412d-8950-a9dd1826e1e8","type":"markdown","markdown":"### Host Coverage"},{"id":"0dbc71e1-c275-409c-9855-6e7c2844e44d","type":"dql","filterSegments":[],"drilldownPath":[],"previousFilterSegments":[],"height":250,"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"fetch dt.entity.host\n| summarize\ntotal = count(),\nwithSecurityContext = countIf(isNotNull(dt.security_context)),\nwithMZs = countIf(isNotNull(managementZones))\n| fieldsAdd \nsecurityContextPercent = round(100.0 * withSecurityContext / total, decimals: 2),\nmzPercent = round(100.0 * withMZs / total, decimals: 2)"},"visualizationSettings":{"table":{"hideColumnsForLargeResults":true},"autoSelectVisualization":true,"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"f0f5153d-e0ef-4803-b724-2ec3732e96fb","type":"markdown","markdown":"---\n\n## 4. Entity Counts by Management Zone\n\nSee how many entities are assigned to each MZ to prioritize migration.\n\n### Services per Management Zone"},{"id":"38179890-5903-4378-97b8-75cd16d1bdd3","type":"dql","filterSegments":[],"drilldownPath":[],"previousFilterSegments":[],"height":250,"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"fetch dt.entity.service\n| expand mz = managementZones\n| filter isNotNull(mz)\n| summarize entityCount = count(), by: {managementZone = mz}\n| sort entityCount desc\n| limit 30"},"visualizationSettings":{"table":{"hideColumnsForLargeResults":true},"autoSelectVisualization":true,"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"4a31d056-73f9-4733-a9d1-41a73f1f07dd","type":"markdown","markdown":"---\n\n## 5. Tag Pattern Analysis\n\nDiscover common tag patterns that could be used for segment creation.\n\n### Most Common Host Tags"},{"id":"61280a3c-867d-43ab-b7d5-13f6ee9ef148","type":"dql","filterSegments":[],"drilldownPath":[],"previousFilterSegments":[],"height":250,"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"fetch dt.entity.host\n| expand tag = tags\n| filter isNotNull(tag)\n| summarize count = count(), by: {tag}\n| sort count desc\n| limit 50"},"visualizationSettings":{"table":{"hideColumnsForLargeResults":true},"autoSelectVisualization":true,"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"8efa7031-a372-4ae1-bb50-a8653ba247c2","type":"markdown","markdown":"### Tag Key Frequency\n\nExtract key from `key:value` format to see which tag keys are most common."},{"id":"7c5a5630-4bf7-4c61-9213-9e6158920925","type":"dql","filterSegments":[],"drilldownPath":[],"previousFilterSegments":[],"height":250,"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"fetch dt.entity.host\n| expand tag = tags\n| filter isNotNull(tag)\n| filter contains(tag, \":\")\n| parse tag, \"LD:tagKey ':' LD:tagValue\"\n| summarize count = count(), uniqueValues = countDistinct(tagValue), by: {tagKey}\n| sort count desc\n| limit 30"},"visualizationSettings":{"table":{"hideColumnsForLargeResults":true},"autoSelectVisualization":true,"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"c077dc51-0aab-47a2-95bf-3c21eaafdefc","type":"markdown","markdown":"---\n\n## 6. Kubernetes Namespace Analysis\n\nK8s namespaces are a common source for segment variables."},{"id":"557b45ab-7003-466b-a131-55649e60c372","type":"dql","filterSegments":[],"drilldownPath":[],"previousFilterSegments":[],"height":250,"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"fetch dt.entity.cloud_application_namespace\n| fields namespace = entity.name, id\n| sort namespace asc\n| limit 30"},"visualizationSettings":{"table":{"hideColumnsForLargeResults":true},"autoSelectVisualization":true,"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"006b922d-5aac-450a-8629-2b08444147d1","type":"markdown","markdown":"---\n\n## 7. Host Group Analysis\n\nHost groups are key for vertical MZ migration (environment-based access control)."},{"id":"dd0abeba-b2e9-4934-8c57-5a26e80980fa","type":"dql","filterSegments":[],"drilldownPath":[],"previousFilterSegments":[],"height":250,"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"fetch dt.entity.host_group\n| fields hostGroup = entity.name, id"},"visualizationSettings":{"table":{"hideColumnsForLargeResults":true},"autoSelectVisualization":true,"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"d445ef52-33c4-47e6-af55-04dfc44fd9d8","type":"markdown","markdown":"---\n\n## 8. Migration Readiness Summary\n\nCombined view of migration readiness indicators."},{"id":"82517464-5954-4ab1-98c2-9152bfa44758","type":"function","showTitle":false,"drilldownPath":[],"state":{"input":{"timeframe":{"from":"now()-2h","to":"now()"},"value":"import { settingsObjectsClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\nimport { queryExecutionClient } from \"@dynatrace-sdk/client-query\";\n\nasync function getMZCount(): Promise<number> {\nconst resp = await settingsObjectsClient.getSettingsObjects({\nschemaIds: \"builtin:management-zones\",\npageSize: 1,\nfields: \"totalCount\"\n});\nreturn resp.totalCount || 0;\n}\n\nasync function runDQL(query: string): Promise<any[]> {\nconst resp = await queryExecutionClient.queryExecute({\nbody: {\nquery,\nrequestTimeoutMilliseconds: 60000,\nmaxResultRecords: 10\n}\n});\nreturn resp.result?.records || [];\n}\n\nexport default async function() {\nconst mzCount = await getMZCount();\n\n// Get service coverage\nconst serviceCoverage = await runDQL(`\nfetch dt.entity.service\n| summarize \ntotal = count(),\nwithSecContext = countIf(isNotNull(dt.security_context)),\nwithMZ = countIf(isNotNull(managementZones))\n`);\n\n// Get host coverage\nconst hostCoverage = await runDQL(`\nfetch dt.entity.host\n| summarize \ntotal = count(),\nwithSecContext = countIf(isNotNull(dt.security_context))\n`);\n\nconst svc = serviceCoverage[0] || {};\nconst host = hostCoverage[0] || {};\n\nreturn [\n{ category: \"Management Zones\", metric: \"Total MZs to migrate\", value: mzCount, status: mzCount > 50 ? \"HIGH\" : \"OK\" },\n{ category: \"Services\", metric: \"Total services\", value: svc.total || 0, status: \"INFO\" },\n{ category: \"Services\", metric: \"With security_context\", value: svc.withSecContext || 0, status: (svc.withSecContext / svc.total) > 0.8 ? \"GOOD\" : \"NEEDS_WORK\" },\n{ category: \"Services\", metric: \"With MZ assignment\", value: svc.withMZ || 0, status: \"INFO\" },\n{ category: \"Hosts\", metric: \"Total hosts\", value: host.total || 0, status: \"INFO\" },\n{ category: \"Hosts\", metric: \"With security_context\", value: host.withSecContext || 0, status: (host.withSecContext / host.total) > 0.8 ? \"GOOD\" : \"NEEDS_WORK\" }\n];\n}"},"visualizationSettings":{"chartSettings":{}},"querySettings":{"maxResultRecords":1000,"defaultScanLimitGbytes":500,"maxResultMegaBytes":1,"defaultSamplingRatio":10,"enableSampling":false},"visualization":"table"}},{"id":"298ac8ee-18c4-4dda-abb4-38c15bf13b64","type":"markdown","markdown":"---\n\n## Next Steps\n\n### Based on the analysis above:\n\n1. **High MZ count?** -> Prioritize by usage (query `dt.sfm.server.management_zones.queries_counter`)\n2. **Low security_context coverage?** -> Plan host tag deployment or OpenPipeline enrichment\n3. **Many tag-based MZ rules?** -> Map to segment filters using `matchesValue(tags, \"key:value\")`\n4. **Many SELECTOR rules?** -> Review entity selectors for segment conversion\n5. **Host groups in use?** -> Use `dt.host_group.id` in boundaries for vertical MZ migration\n\n### Migration Priority:\n\n| Priority | Criteria | Action |\n|----------|----------|--------|\n| 1 | MZs with >100 entities | Migrate first - highest impact |\n| 2 | Tag-based MZ rules | Easy segment conversion |\n| 3 | Host group-based MZs | Use boundary on `dt.host_group.id` |\n| 4 | Entity selector MZs | Review and convert to segments |\n| 5 | Complex/nested MZs | Manual analysis required |\n\n---\n\n## Related Notebooks\n\n- **MZ2POL-01**: Introduction - Why Migrate\n- **MZ2POL-03**: Assessment and Planning\n- **MZ2POL-06**: Migration Execution\n- **MZ2POL-07**: Validation and Troubleshooting\n\n## Documentation\n\n- [Management Zones Documentation](https://docs.dynatrace.com/docs/manage/identity-access-management/permission-management/management-zones)\n- [Upgrade from RBAC to IAM Policies](https://docs.dynatrace.com/docs/manage/identity-access-management/permission-management/manage-user-permissions-policies/advanced/migrate-roles)\n- [Grant Access to Entities with Security Context](https://docs.dynatrace.com/docs/manage/identity-access-management/use-cases/access-security-context)\n\n---\n\n*MZ2POL-00: SDK Management Zone Analysis Tool - Part of the MZ to Policies/Boundaries/Segments Series*"}],"name":"--MZ2POL-00-sdk-mz-analysis-tool"}