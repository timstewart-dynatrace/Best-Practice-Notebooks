<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 620">
  <defs>
    <linearGradient id="mProblemGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="mStepGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="mYesGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="mNoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="mFixGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="criticalGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#991b1b;stop-opacity:1" />
    </linearGradient>
    <filter id="mShadow">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
    </filter>
    <marker id="mArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
    <marker id="mYesArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
    </marker>
    <marker id="mNoArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f59e0b"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="800" height="620" fill="#0f172a" rx="10"/>

  <!-- Title -->
  <text x="400" y="35" font-family="system-ui, -apple-system, sans-serif" font-size="20" font-weight="bold" fill="#f1f5f9" text-anchor="middle">Decision Tree 3: Masking Not Working</text>

  <!-- Problem Box - Critical -->
  <rect x="200" y="55" width="400" height="50" rx="8" fill="url(#criticalGrad)" filter="url(#mShadow)"/>
  <text x="220" y="75" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#fecaca">⚠️ CRITICAL</text>
  <text x="400" y="93" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#fff" text-anchor="middle">Sensitive data (PII/PHI/CHD) visible in stored logs</text>

  <!-- Arrow to Step 1 -->
  <line x1="400" y1="105" x2="400" y2="130" stroke="#64748b" stroke-width="2" marker-end="url(#mArrow)"/>

  <!-- Step 1 -->
  <rect x="180" y="135" width="440" height="55" rx="8" fill="url(#mStepGrad)" filter="url(#mShadow)"/>
  <circle cx="210" cy="162" r="15" fill="rgba(255,255,255,0.2)"/>
  <text x="210" y="168" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#fff" text-anchor="middle">1</text>
  <text x="420" y="155" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#fff" text-anchor="middle">Is the masking processor running?</text>
  <text x="420" y="175" font-family="monospace" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">Query: fetch logs | filter contains(content, "4111") | limit 1</text>

  <!-- Step 1 Branches -->
  <line x1="280" y1="190" x2="280" y2="220" stroke="#f59e0b" stroke-width="2"/>
  <line x1="280" y1="220" x2="150" y2="220" stroke="#f59e0b" stroke-width="2" marker-end="url(#mNoArrow)"/>
  <text x="215" y="215" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#f59e0b">FOUND ✗</text>

  <line x1="520" y1="190" x2="520" y2="220" stroke="#10b981" stroke-width="2"/>
  <line x1="520" y1="220" x2="650" y2="220" stroke="#10b981" stroke-width="2" marker-end="url(#mYesArrow)"/>
  <text x="585" y="215" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#10b981">NOT FOUND ✓</text>

  <!-- Found = Masking NOT working, go to Step 2 -->
  <rect x="40" y="230" width="150" height="35" rx="6" fill="url(#mNoGrad)"/>
  <text x="115" y="252" font-family="system-ui, sans-serif" font-size="11" fill="#fff" text-anchor="middle">Masking broken → Step 2</text>

  <!-- Not Found = May be working -->
  <rect x="620" y="230" width="160" height="50" rx="6" fill="url(#mYesGrad)"/>
  <text x="700" y="250" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff" text-anchor="middle">May be working</text>
  <text x="700" y="268" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.9)" text-anchor="middle">Verify with known test data</text>

  <!-- Step 2 -->
  <line x1="115" y1="265" x2="115" y2="300" stroke="#64748b" stroke-width="2" marker-end="url(#mArrow)"/>
  <rect x="40" y="305" width="400" height="55" rx="8" fill="url(#mStepGrad)" filter="url(#mShadow)"/>
  <circle cx="70" cy="332" r="15" fill="rgba(255,255,255,0.2)"/>
  <text x="70" y="338" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#fff" text-anchor="middle">2</text>
  <text x="260" y="325" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#fff" text-anchor="middle">Is the processor order correct?</text>
  <text x="260" y="345" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">Masking BEFORE parsing? Field masking AFTER parsing?</text>

  <!-- Step 2 Branches -->
  <line x1="140" y1="360" x2="140" y2="390" stroke="#10b981" stroke-width="2"/>
  <line x1="140" y1="390" x2="60" y2="390" stroke="#10b981" stroke-width="2" marker-end="url(#mYesArrow)"/>
  <text x="100" y="385" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#10b981">✓</text>

  <line x1="320" y1="360" x2="320" y2="390" stroke="#f59e0b" stroke-width="2"/>
  <line x1="320" y1="390" x2="400" y2="390" stroke="#f59e0b" stroke-width="2" marker-end="url(#mNoArrow)"/>
  <text x="360" y="385" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#f59e0b">✗</text>

  <!-- Yes - Go to Step 3 -->
  <rect x="25" y="400" width="80" height="30" rx="6" fill="url(#mYesGrad)"/>
  <text x="65" y="420" font-family="system-ui, sans-serif" font-size="10" fill="#fff" text-anchor="middle">Step 3 ↓</text>

  <!-- No - Order Issue -->
  <rect x="400" y="375" width="180" height="85" rx="6" fill="url(#mFixGrad)" filter="url(#mShadow)"/>
  <text x="490" y="395" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff" text-anchor="middle">Processor Order Issue</text>
  <text x="410" y="415" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.9)">• Move masking earlier</text>
  <text x="410" y="432" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.9)">• Content masking FIRST</text>
  <text x="410" y="449" font-family="system-ui, sans-serif" font-size="10" fill="#fcd34d">→ Reorder &amp; test</text>

  <!-- Step 3 -->
  <line x1="65" y1="430" x2="65" y2="465" stroke="#64748b" stroke-width="2" marker-end="url(#mArrow)"/>
  <rect x="40" y="470" width="400" height="55" rx="8" fill="url(#mStepGrad)" filter="url(#mShadow)"/>
  <circle cx="70" cy="497" r="15" fill="rgba(255,255,255,0.2)"/>
  <text x="70" y="503" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#fff" text-anchor="middle">3</text>
  <text x="260" y="490" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#fff" text-anchor="middle">Does the regex pattern match?</text>
  <text x="260" y="510" font-family="monospace" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">Test: replaceAll(content, "\\b\\d{4}...\\d{4}\\b", "[REDACTED]")</text>

  <!-- Step 3 Branches -->
  <line x1="140" y1="525" x2="140" y2="555" stroke="#10b981" stroke-width="2"/>
  <line x1="140" y1="555" x2="60" y2="555" stroke="#10b981" stroke-width="2" marker-end="url(#mYesArrow)"/>
  <text x="100" y="550" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#10b981">✓</text>

  <line x1="320" y1="525" x2="320" y2="555" stroke="#f59e0b" stroke-width="2"/>
  <line x1="320" y1="555" x2="400" y2="555" stroke="#f59e0b" stroke-width="2" marker-end="url(#mNoArrow)"/>
  <text x="360" y="550" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#f59e0b">✗</text>

  <!-- Yes - Go to Step 4 -->
  <rect x="25" y="565" width="80" height="30" rx="6" fill="url(#mYesGrad)"/>
  <text x="65" y="585" font-family="system-ui, sans-serif" font-size="10" fill="#fff" text-anchor="middle">Step 4 ↓</text>

  <!-- No - Pattern Issue -->
  <rect x="400" y="540" width="180" height="70" rx="6" fill="url(#mFixGrad)" filter="url(#mShadow)"/>
  <text x="490" y="560" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff" text-anchor="middle">Pattern Issue</text>
  <text x="410" y="580" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.9)">• Escaping correct? (\\d)</text>
  <text x="410" y="597" font-family="system-ui, sans-serif" font-size="10" fill="#fcd34d">→ Update regex pattern</text>

  <!-- Step 4 - Final -->
  <rect x="120" y="565" width="240" height="45" rx="8" fill="url(#mStepGrad)" filter="url(#mShadow)"/>
  <circle cx="145" cy="587" r="12" fill="rgba(255,255,255,0.2)"/>
  <text x="145" y="592" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#fff" text-anchor="middle">4</text>
  <text x="250" y="582" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#fff" text-anchor="middle">All fields masked?</text>
  <text x="250" y="600" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">Check ALL fields for leaks</text>

  <!-- Final outcomes -->
  <rect x="600" y="470" width="170" height="55" rx="6" fill="url(#mYesGrad)" filter="url(#mShadow)"/>
  <text x="685" y="493" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#fff" text-anchor="middle">✓ All Masked</text>
  <text x="685" y="512" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.9)" text-anchor="middle">Masking complete!</text>

  <rect x="600" y="535" width="170" height="70" rx="6" fill="url(#criticalGrad)" filter="url(#mShadow)"/>
  <text x="685" y="558" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#fff" text-anchor="middle">✗ Data Leaked</text>
  <text x="610" y="578" font-family="system-ui, sans-serif" font-size="10" fill="rgba(255,255,255,0.9)">• Add field masking</text>
  <text x="610" y="595" font-family="system-ui, sans-serif" font-size="10" fill="#fcd34d">→ Use fieldsRemove</text>

  <!-- Connecting lines to final boxes -->
  <line x1="360" y1="587" x2="595" y2="500" stroke="#10b981" stroke-width="2" marker-end="url(#mYesArrow)"/>
  <line x1="360" y1="587" x2="595" y2="570" stroke="#f59e0b" stroke-width="2" marker-end="url(#mNoArrow)"/>
</svg>
